name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install system dependencies for Bambu Studio CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          build-essential \
          cmake \
          curl \
          xvfb \
          eglexternalplatform-dev \
          extra-cmake-modules \
          file \
          git \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-libav \
          libcairo2-dev \
          libcurl4-openssl-dev \
          libdbus-1-dev \
          libglew-dev \
          libglu1-mesa-dev \
          libgstreamer1.0-dev \
          libgstreamerd-3-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer-plugins-good1.0-dev \
          libgtk-3-dev \
          libosmesa6-dev \
          libsecret-1-dev \
          libsoup2.4-dev \
          libssl3 \
          libssl-dev \
          libudev-dev \
          libwayland-dev \
          libxkbcommon-dev \
          locales \
          locales-all \
          m4 \
          pkgconf \
          sudo \
          wayland-protocols \
          libwebkit2gtk-4.1-dev \
          wget \
          binutils \
          fuse \
          libfuse2 \
          libxcb1 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-render0 \
          libxcb-shape0 \
          libxcb-sync1 \
          libxcb-util1 \
          libxcb-xfixes0 \
          libxcb-xinerama0 \
          libxcb-xkb1 \
          libxkbcommon-x11-0 \
          libxkbcommon0 \
          ca-certificates \
          gnupg \
          libegl1 \
          libegl-mesa0 \
          libgl1-mesa-dri \
          libopengl0 \
          libgstreamer1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libsoup-2.4-1 \
          libgtk-3-0t64 \
          libglib2.0-0t64 \
          libdbus-1-3 \
          libfontconfig1 \
          libfreetype6 \
          libgssapi-krb5-2 \
          libdrm2 \
          libxss1 \
          libasound2t64 \
          libxrandr2 \
          libxcomposite1 \
          libxdamage1 \
          libxi6 \
          libxfixes3 \
          libxcursor1 \
          libxinerama1 \
          libwebkit2gtk-4.1-0
        
    - name: Install Bambu Studio CLI
      run: |
        chmod +x scripts/install-bambu-studio-cli.sh
        sudo scripts/install-bambu-studio-cli.sh
        
    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8
        
    - name: Run Python linter (flake8)
      run: |
        python -m flake8 backend/
        
    - name: Verify Bambu Studio CLI installation
      run: |
        bambu-studio-cli --help || echo "CLI help command failed, but CLI may still be functional"
        bambu-studio-cli --version || echo "CLI version command failed, but CLI may still be functional"
        
    - name: Run backend tests
      run: |
        cd backend
        # Set up virtual display for headless environment
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        # Run tests with verbose output and coverage
        python -m pytest tests/ -v --cov=app --cov-report=term-missing -s
        
    - name: Set up Node.js for PWA
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install PWA dependencies and build
      run: |
        cd pwa
        npm install
        npm run build
        
    - name: Build Docker image
      run: |
        docker build .